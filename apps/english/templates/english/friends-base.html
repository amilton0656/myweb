{% load static %}
<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" href="{% static 'accounts/images/favicon.ico' %}" type="image/x-icon">
  {% block title %}
  {% endblock title %}
  <link rel="stylesheet" href="{% static 'css/style_friends.css' %}" />
</head>

<body>
  <div class="video-container">
    {% block video %}
    {% endblock video %}
  </div>

  <div class="container">
    <ul id="lista-dialogo"></ul>
  </div>
  <script>
    {% block script %}
    {% endblock script %}
    // 2. LÓGICA PARA CRIAR A LISTA
    // Este código será executado assim que o HTML da página for carregado.
    document.addEventListener("DOMContentLoaded", () => {
      const listaDialogoElement = document.getElementById("lista-dialogo");

      // Itera sobre cada item do nosso array de dados
      dialogoData.forEach((item) => {
        // Cria um novo elemento <li>
        const li = document.createElement("li");
        li.className = "linha-dialogo";

        // Define o conteúdo HTML do <li> usando os dados do item atual
        li.innerHTML = `
            <div class="frases">
              <span class="frase-pt">${item.pt}</span>
              <span class="frase-en">${item.en}</span>
            </div>
            <button class="btn-play" data-inicio="${item.inicio}" data-fim="${item.fim}">▶</button>
          `;

        // Adiciona o <li> recém-criado à lista <ul> no HTML
        listaDialogoElement.appendChild(li);
      });
    });

    // Espera o HTML ser totalmente carregado
    document.addEventListener('DOMContentLoaded', () => {
      const video = document.getElementById('meuVideo');
      const listaDialogo = document.getElementById('lista-dialogo');

      if (!video) {
        console.warn('[friends] #meuVideo não encontrado');
        return;
      }
      if (!listaDialogo) {
        console.warn('[friends] #lista-dialogo não encontrado');
        return;
      }

      let pontoDeParada = null;
      let linhaAtiva = null;

      // Tocar trecho com segurança
      function reproduzirTrecho(inicio, fim) {
        const start = Number(inicio) + 0.01; // pequeno offset
        const end = Number(fim);
        pontoDeParada = end;

        const doSeekAndPlay = () => {
          video.pause();
          video.currentTime = start;

          const onSeeked = () => {
            video.removeEventListener('seeked', onSeeked);
            video.play();
          };
          video.addEventListener('seeked', onSeeked, { once: true });
          setTimeout(() => video.play(), 50); // fallback
        };

        if (video.readyState < 1) {
          const onLoadedMeta = () => {
            video.removeEventListener('loadedmetadata', onLoadedMeta);
            doSeekAndPlay();
          };
          video.addEventListener('loadedmetadata', onLoadedMeta, { once: true });
        } else {
          doSeekAndPlay();
        }
      }

      // Clique em qualquer parte da linha (ou no botão ▶)
      listaDialogo.addEventListener('click', (evento) => {
        const li = evento.target.closest('.linha-dialogo');
        if (!li) return;

        const botao = li.querySelector('.btn-play');
        if (!botao) return;

        const inicio = parseFloat(botao.dataset.inicio);
        const fim = parseFloat(botao.dataset.fim);

        // Destaque de linha
        if (linhaAtiva) linhaAtiva.classList.remove('active');
        li.classList.add('active');
        linhaAtiva = li;

        li.scrollIntoView({ behavior: 'smooth', block: 'center' });
        evento.preventDefault();

        reproduzirTrecho(inicio, fim);
      });

      // Pausar no fim do trecho
      video.addEventListener('timeupdate', () => {
        if (pontoDeParada != null && video.currentTime >= (pontoDeParada - 0.03)) {
          video.pause();
          pontoDeParada = null;

          if (linhaAtiva) {
            linhaAtiva.classList.remove('active');
            linhaAtiva = null;
          }
        }
      });
    });

  </script>


</body>

</html>